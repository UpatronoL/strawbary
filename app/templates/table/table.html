{% extends 'base.html' %}
 
{% block title %}
  <span data-i18n="title">Sensor Measurements</span>
{% endblock %}
 
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='table.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
{% endblock %}
 
{% block content %}
<div class="container">
  <div class="table-container">
    <!-- Header with current date info -->
    <div class="header-section">
      {% if selected_date %}
        <h2 class="table-title">
          <span data-i18n="measurementsFor">Measurements for</span> 
          {{ selected_date.strftime('%B %d') }}
        </h2>
      {% else %}
        <h2 class="table-title" data-i18n="todayMeasurements">Today's Measurements</h2>
      {% endif %}
    </div>

    <!-- Date filter -->
    <div class="filter-bar">
      <form id="date-filter-form" method="get" action="{{ url_for('table.table') }}">
        <div class="date-filter">
          <label for="date-select" data-i18n="selectDate">Select Date:</label>
          <input type="date" id="date-select" name="date" value="{{ selected_date or '' }}">
          <button type="submit" class="filter-button" data-i18n="apply">Apply</button>
          <a href="{{ url_for('table.table') }}" 
             class="reset-button" 
             id="show-today-button" 
             data-i18n="showToday">
            Show Today
          </a>
        </div>
      </form>
    </div>
 
    <!-- Column-specific filter -->
    <div class="datatable-filter">
      <select id="filter-column">
        <option value="0" data-i18n="headerDate">Date</option>
        <option value="1" data-i18n="headerTime">Time</option>
        <option value="2" data-i18n="headerTemperature">Temperature</option>
        <option value="3" data-i18n="headerHumidity">Humidity</option>
        <option value="4" data-i18n="headerLightIntensity">Light Intensity</option>
        <option value="5" data-i18n="headerGroundTemperature">Ground Temperature</option>
        <option value="6" data-i18n="headerGroundHumidity">Ground Humidity</option>
      </select>
      <input type="text"
             id="table-filter"
             data-i18n="filterValuePlaceholder"
             placeholder="Filter Value">
    </div>
 
    <!-- Data Table -->
    <table id="measurements-table" class="display">
      <thead>
        <tr>
          <th data-i18n="headerDate">Date</th>
          <th data-i18n="headerTime">Time</th>
          <th>Temp (°C)</th>
          <th>Hum (%)</th>
          <th>Light (Lux)</th>
          <th>G. Temp (°C)</th>
          <th>G. Hum (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in measurements %}
        <tr>
          <td>{{ row['Date'].strftime('%b %d') if row['Date'] else '' }}</td>
          <td>{{ row['Time'] or '' }}</td>
          <td class="temperature-cell">{{ "%.1f"|format(row['Temperature']) if row['Temperature'] is not none else 'N/A' }}</td>
          <td class="humidity-cell">{{ "%.1f"|format(row['Humidity']) if row['Humidity'] is not none else 'N/A' }}</td>
          <td class="light-cell">{{ "%.0f"|format(row['Light Intensity']) if row['Light Intensity'] is not none else 'N/A' }}</td>
          <td class="ground-temp-cell">{{ "%.1f"|format(row['Ground Temperature']) if row['Ground Temperature'] is not none else 'N/A' }}</td>
          <td class="ground-humidity-cell">{{ "%.1f"|format(row['Ground Humidity']) if row['Ground Humidity'] is not none else 'N/A' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
 
  <div class="sticky-sidebar">
    <div class="download-container">
      <h2 data-i18n="downloadTitle">Export Data</h2>
      <a href="{{ url_for('table.download_csv') }}"
         class="download-button"
         data-i18n="downloadBtn">
        <i class="fas fa-download"></i> Download CSV
      </a>
    </div>

    <div class="quick-stats">
      <h3 data-i18n="quickStats">Quick Stats</h3>
      <div class="stat-item">
        <span class="stat-label" data-i18n="totalRecords">Total Records:</span>
        <span class="stat-value">{{ measurements|length }}</span>
      </div>
      {% if measurements %}
      <div class="stat-item">
        <span class="stat-label" data-i18n="timeRange">Time Range:</span>
        <span class="stat-value">
          {{ measurements[0]['Time'] }} - {{ measurements[-1]['Time'] }}
        </span>
      </div>
      {% endif %}
    </div>
  </div>
</div>
 
<!-- DataTables initialization -->
<script>
  $(document).ready(function() {
    $('#measurements-table').DataTable({
      paging: true,
      pageLength: 25,
      lengthMenu: [[10,25,50,100,-1],[10,25,50,100,"All"]],
      searching: true,
      autoWidth: false,
      responsive: true,
      order: [[1,'desc']], // Sort by time descending
      dom: '<"top"lf>rt<"bottom"ip><"clear">',
      columnDefs: [
        { targets: [2,3,4,5,6], className: "text-center" },
        { targets: [0,1], className: "text-left" }
      ]
    });

    // Custom filter functionality
    $('#filter-column, #table-filter').on('keyup change', function() {
      var table = $('#measurements-table').DataTable();
      var columnIndex = $('#filter-column').val();
      var filterValue = $('#table-filter').val();
      
      table.column(columnIndex).search(filterValue).draw();
    });
  });
</script>
{% endblock %}