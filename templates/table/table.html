{% extends 'base.html' %}

{% block title %}Sensor Measurements{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='table.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

{% endblock %}

{% block content %}
<div class="container">
    <div class="table-container">
        <!-- Date filter -->
        <div class="filter-bar">
            <form id="date-filter-form" method="get" action="{{ url_for('table.table') }}">
                <div class="date-filter">
                    <label for="date-select">Filter by date:</label>
                    <input type="date" id="date-select" name="date">
                    <button type="submit" class="filter-button">Apply</button>
                    <a href="{{ url_for('table.table') }}" class="reset-button" id="show-all-button">Show All</a>
                </div>
            </form>
        </div>

        <!-- DataTable filter options -->
        <div class="datatable-filter">
            <select id="filter-column">
                <option value="0">Date</option>
                <option value="1">Time</option>
                <option value="2">Temperature</option>
                <option value="3">Humidity</option>
                <option value="4">Light Intensity</option>
                <option value="5">Ground Temperature</option>
                <option value="6">Ground Humidity</option>
            </select>
            <input type="text" id="table-filter" placeholder="Filter Value">
        </div>

        <!-- Table -->
        <table id="measurements-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Temperature</th>
                    <th>Humidity</th>
                    <th>Light Intensity</th>
                    <th>Ground Temperature</th>
                    <th>Ground Humidity</th>
                </tr>
            </thead>
            <tbody>
                {% for row in measurements %}
                <tr>
                    <td>{% if row['Date'] %}{{ row['Date'] }}{% endif %}</td>
                    <td>{% if row['Time'] %}{{ row['Time'] }}{% endif %}</td>
                    <td>{% if row['Temperature'] %}{{ row['Temperature'] }}{% endif %}</td>
                    <td>{% if row['Humidity'] %}{{ row['Humidity'] }}{% endif %}</td>
                    <td>{% if row['Light Intensity'] %}{{ row['Light Intensity'] }}{% endif %}</td>
                    <td>{% if row['Ground Temperature'] %}{{ row['Ground Temperature'] }}{% endif %}</td>
                    <td>{% if row['Ground Humidity'] %}{{ row['Ground Humidity'] }}{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="sticky-sidebar">
        <div class="summary-container">
            <h2>Temperature Summary</h2>
            {% if max_temp is not none and min_temp is not none and mean_temp is not none %}
            <p><strong>Max Temperature:</strong> {{ max_temp }} Â°C</p>
            <p><strong>Min Temperature:</strong> {{ min_temp }} Â°C</p>
            <p><strong>Mean Temperature:</strong> {{ "%.1f" | format(mean_temp) }} Â°C</p>
            {% if daytime_avg is not none %}
            <p><strong>Daytime Average:</strong> {{ "%.1f" | format(daytime_avg) }} Â°C</p>
            {% endif %}
            {% if nighttime_avg is not none %}
            <p><strong>Nighttime Average:</strong> {{ "%.1f" | format(nighttime_avg) }} Â°C</p>
            {% endif %}
            {% else %}
            <p>No temperature data available.</p>
            {% endif %}
        </div>

        <div class="download-container">
            <h2>Click here ðŸ‘‡</h2>
            <a href="{{ url_for('table.download_csv') }}" class="download-button">
                <i class="fas fa-download"></i> Download Data
            </a>
        </div>
    </div>
</div>

<!-- DataTables initialization script -->
<script>
    $(document).ready(function() {
        const table = $('#measurements-table').DataTable({
            paging: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            searching: true,
            autoWidth: false,
            responsive: true,
            order: [[0, 'desc'], [1, 'desc']], 
            dom: '<"top"lf>rt<"bottom"ip><"clear">',
            language: {
                search: "",
                searchPlaceholder: "Search all columns...",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries"
            }
        });
    
        // Function to calculate date 7 days ago
        function getDateSevenDaysAgo() {
            const date = new Date();
            date.setDate(date.getDate() - 7);
            return date.toISOString().split('T')[0];
        }
    
        // Column filtering functionality
        function applyColumnFilter() {
            const columnIndex = $('#filter-column').val();
            const filterValue = $('#table-filter').val().trim();
            
            table.search('').columns().search('').draw();
            
            if (filterValue) {
                table.column(columnIndex).search(filterValue).draw();
            }
        }
    
        // Set up filter event handlers
        $('#filter-column').on('change', applyColumnFilter);
        $('#table-filter').on('keyup', function(e) {
            if (e.key === 'Enter') {
                applyColumnFilter();
            } else {
                clearTimeout(this.delay);
                this.delay = setTimeout(applyColumnFilter, 500);
            }
        });
    
        // Date input configuration
        const dateInput = document.getElementById('date-select');
        if (dateInput) {
            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            dateInput.setAttribute('max', today);
            
            // Set default date range to last 7 days
            const sevenDaysAgo = getDateSevenDaysAgo();
            dateInput.setAttribute('min', sevenDaysAgo);
            dateInput.value = '';
        }
    
       
        $('#show-all-button').on('click', function(e) {
            e.preventDefault();
            
            // Clear any existing filters
            table.search('').columns().search('').draw();
            if (dateInput) dateInput.value = '';
            
            // Filter the table to show only last 7 days
            const sevenDaysAgo = getDateSevenDaysAgo();
            const today = new Date().toISOString().split('T')[0];
            
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    const rowDate = data[0]; // Get date from first column
                    return (rowDate >= sevenDaysAgo && rowDate <= today);
                }
            );
            
            table.draw();
            
            $.fn.dataTable.ext.search.pop();
            

            table.page.len(-1).draw();
        });
    
        // Handle "All" selection from length menu
        table.on('length.dt', function(e, settings, len) {
            if (len === -1) {
                table.page.len(table.data().count()).draw();
            }
        });
    });
    </script>
    
    
{% endblock %}